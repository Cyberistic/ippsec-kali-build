- name: "Find default Firefox profile"
  shell: |
    if [ -f "{{ ansible_env.HOME }}/.mozilla/firefox/profiles.ini" ]; then
      grep -A2 "Default=1" "{{ ansible_env.HOME }}/.mozilla/firefox/profiles.ini" | grep "^Path=" | cut -d'=' -f2
    fi
  register: default_profile
  changed_when: false
  failed_when: false

- name: "Get first available profile if no default exists"
  shell: |
    if [ -d "{{ ansible_env.HOME }}/.mozilla/firefox" ]; then
      find "{{ ansible_env.HOME }}/.mozilla/firefox" -maxdepth 1 -type d -name "*.default*" -o -name "*.default-release*" | head -n1 | xargs basename
    fi
  register: first_profile
  changed_when: false
  failed_when: false
  when: default_profile.stdout == ""

- name: "Set target profile path"
  set_fact:
    target_profile: "{{ default_profile.stdout if default_profile.stdout != '' else (first_profile.stdout | default('')) }}"

- name: "Debug target profile"
  debug:
    msg: "Target Firefox profile: {{ target_profile }}"

- name: "Check if target profile exists"
  stat:
    path: "{{ ansible_env.HOME }}/.mozilla/firefox/{{ target_profile }}"
  register: profile_dir
  when: target_profile != ""

- name: "Kill Firefox if running"
  shell: pkill -9 firefox || true
  changed_when: false
  when: target_profile != "" and profile_dir.stat.exists

- name: "Wait for Firefox to close"
  pause:
    seconds: 2
  when: target_profile != "" and profile_dir.stat.exists

- name: "Deploy Firefox profile extensions"
  copy:
    src: "files/firefox-profile/extensions/"
    dest: "{{ ansible_env.HOME }}/.mozilla/firefox/{{ target_profile }}/extensions/"
    mode: "0644"
  when: target_profile != "" and profile_dir.stat.exists

- name: "Check which preference files exist in source"
  stat:
    path: "{{ role_path }}/files/firefox-profile/{{ item }}"
  loop:
    - prefs.js
    - handlers.json
    - search.json.mozlz4
  register: pref_files
  delegate_to: localhost

- name: "Deploy Firefox profile preferences"
  copy:
    src: "files/firefox-profile/{{ item.item }}"
    dest: "{{ ansible_env.HOME }}/.mozilla/firefox/{{ target_profile }}/{{ item.item }}"
    mode: "0644"
    backup: yes
  loop: "{{ pref_files.results }}"
  when:
    - target_profile != ""
    - profile_dir.stat.exists
    - item.stat.exists

- name: "Updating Firefox Policies"
  template:
    src: "templates/policies.json.j2"
    dest: "/usr/share/firefox-esr/distribution/policies.json"
  become: true
  become_method: sudo
