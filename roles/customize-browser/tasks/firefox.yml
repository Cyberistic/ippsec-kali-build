- name: "Find default Firefox profile"
  shell: |
    if [ -f "{{ ansible_env.HOME }}/.mozilla/firefox/profiles.ini" ]; then
      grep -A2 "Default=1" "{{ ansible_env.HOME }}/.mozilla/firefox/profiles.ini" | grep "^Path=" | cut -d'=' -f2
    fi
  register: default_profile
  changed_when: false
  failed_when: false

- name: "Get first available profile if no default exists"
  shell: |
    if [ -d "{{ ansible_env.HOME }}/.mozilla/firefox" ]; then
      find "{{ ansible_env.HOME }}/.mozilla/firefox" -maxdepth 1 -type d -name "*.default*" -o -name "*.default-release*" | head -n1 | xargs basename
    fi
  register: first_profile
  changed_when: false
  failed_when: false
  when: default_profile.stdout == ""

- name: "Set target profile path"
  set_fact:
    target_profile: "{{ default_profile.stdout if default_profile.stdout != '' else first_profile.stdout }}"

- name: "Deploy Firefox profile extensions"
  copy:
    src: "files/firefox-profile/extensions/"
    dest: "{{ ansible_env.HOME }}/.mozilla/firefox/{{ target_profile }}/extensions/"
    mode: "0644"
  when: target_profile != ""

- name: "Deploy Firefox profile preferences"
  copy:
    src: "files/firefox-profile/{{ item }}"
    dest: "{{ ansible_env.HOME }}/.mozilla/firefox/{{ target_profile }}/{{ item }}"
    mode: "0644"
    backup: yes
  loop:
    - prefs.js
    - handlers.json
    - search.json.mozlz4
  when: target_profile != ""
  ignore_errors: yes

- name: "Updating Firefox Policies"
  template:
    src: "templates/policies.json.j2"
    dest: "/usr/share/firefox-esr/distribution/policies.json"
  become: true
  become_method: sudo
