- name: "Find default Firefox profile"
  shell: |
    if [ -f "{{ ansible_env.HOME }}/.mozilla/firefox/profiles.ini" ]; then
      grep -A2 "Default=1" "{{ ansible_env.HOME }}/.mozilla/firefox/profiles.ini" | grep "^Path=" | cut -d'=' -f2
    fi
  register: default_profile
  changed_when: false
  failed_when: false

- name: "Get first available profile if no default exists"
  shell: |
    if [ -d "{{ ansible_env.HOME }}/.mozilla/firefox" ]; then
      find "{{ ansible_env.HOME }}/.mozilla/firefox" -maxdepth 1 -type d -name "*.default*" -o -name "*.default-release*" | head -n1 | xargs basename
    fi
  register: first_profile
  changed_when: false
  failed_when: false
  when: default_profile.stdout == ""

- name: "Set target profile path"
  set_fact:
    target_profile: "{{ default_profile.stdout if default_profile.stdout != '' else (first_profile.stdout | default('')) }}"

- name: "Debug target profile"
  debug:
    msg: "Target Firefox profile: {{ target_profile }}"

- name: "Kill Firefox if running"
  shell: pkill -9 firefox || true
  changed_when: false

- name: "Wait for Firefox to close"
  pause:
    seconds: 2

- name: "Deploy complete Firefox profile"
  synchronize:
    src: "files/firefox-profile/"
    dest: "{{ ansible_env.HOME }}/.mozilla/firefox/{{ target_profile }}/"
    recursive: yes
    delete: no
  delegate_to: "{{ inventory_hostname }}"
  when: target_profile != ""

- name: "Set correct permissions on profile directory"
  file:
    path: "{{ ansible_env.HOME }}/.mozilla/firefox/{{ target_profile }}"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    recurse: yes
  when: target_profile != ""

- name: "Updating Firefox Policies"
  template:
    src: "templates/policies.json.j2"
    dest: "/usr/share/firefox-esr/distribution/policies.json"
  become: true
  become_method: sudo
